<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#D0021B">
    
    <title>SAIS Schedule</title>
    
    <!-- Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #D0021B;
            --primary-dark: #990000;
            --header-bg: #1e293b;
            --border-color: #cbd5e1;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        html, body, #root { 
            height: 100%; width: 100%; margin: 0; 
            /* ใช้ dvh เพื่อแก้ปัญหามือถือที่มีแถบบราวเซอร์ยืดหด */
            height: 100dvh; 
        }
        
        body { 
            font-family: 'Sarabun', sans-serif; 
            background-color: #f1f5f9; 
            color: #0f172a; 
            -webkit-font-smoothing: antialiased;
            overflow: hidden; 
        }

        .app-container { height: 100%; display: flex; flex-direction: column; background: white; }

        /* Header (Compact Height) */
        .main-header {
            background: var(--primary); color: white;
            padding-top: max(8px, var(--safe-top)); padding-bottom: 4px;
            padding-left: 12px; padding-right: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 50; flex-shrink: 0;
            display: flex; align-items: center; justify-content: space-between;
            height: 50px; /* ลดความสูงลง */
        }

        /* Grid System */
        .grid-container { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        
        .nav-bar {
            background: white; padding: 4px 12px; /* ลด Padding */
            border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
            flex-shrink: 0; z-index: 40;
            height: 36px; /* กำหนดความสูงแน่นอน */
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .table-header {
            display: flex; background: #1e293b; color: white;
            z-index: 30; flex-shrink: 0;
            height: 30px; /* ลดความสูงหัวตาราง */
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }

        .grid-body {
            flex-grow: 1; display: grid; 
            /* บังคับแบ่ง 16 ส่วนเท่าๆ กันในพื้นที่ที่เหลือ (minmax(0, 1fr) สำคัญมากเพื่อไม่ให้ล้น) */
            grid-template-rows: repeat(16, minmax(0, 1fr));
            overflow: hidden; 
            background: white;
            /* เว้นระยะด้านล่างสำหรับมือถือที่มีขีด Home */
            padding-bottom: var(--safe-bottom);
        }

        .grid-row { display: flex; border-bottom: 1px solid #e2e8f0; }
        .grid-row:nth-child(even) { background-color: #fff; } 

        /* Cells */
        .cell-date {
            width: 45px; flex-shrink: 0; 
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            border-right: 1px solid #94a3b8;
            background: #fff;
            font-weight: 700; font-size: 13px; color: #334155; 
            z-index: 10;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
        }

        /* Slot Cell */
        .cell-slot {
            flex: 1; 
            border-right: 1px solid #e2e8f0; 
            position: relative;
            display: flex; align-items: stretch; justify-content: stretch;
            padding: 0; 
            transition: background 0.1s;
        }
        .cell-slot:active { background-color: #e0e7ff; }

        /* Task Content */
        .task-content {
            width: 100%; height: 100%;
            display: flex; flex-direction: column; 
            justify-content: center; align-items: center;
            text-align: center;
            padding: 0 1px;
            overflow: hidden;
        }
        
        .status-pending { background: #f8fafc; border-left: 2px solid #cbd5e1; }
        .status-done { background: #dcfce7; border-left: 2px solid #16a34a; }

        .text-line-1 {
            font-size: 9px; font-weight: 700; 
            line-height: 1; color: #000;
            white-space: nowrap; width: 100%;
        }
        .text-line-2 {
            font-size: 8px; font-weight: 400; 
            line-height: 1; color: #475569;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            width: 100%; margin-top: 1px;
        }

        /* Highlights */
        .is-today { background: #eff6ff !important; box-shadow: inset 3px 0 0 #2563eb; }
        .is-sunday { background-color: #D0021B !important; color: white !important; border-right: 1px solid #991b1b; }
        .is-sunday-slot { background-color: #fff1f2 !important; border-right: 1px solid #fecaca; }
        .is-holiday-row { background: #fff1f2 !important; }
        
        .holiday-label {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-15deg);
            font-size: 9px; font-weight: 900; color: #ef4444; opacity: 0.15; pointer-events: none; white-space: nowrap;
        }

        /* Buttons & Icons */
        .btn-close-modern { position: absolute; top: 12px; right: 12px; width: 36px; height: 36px; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #64748b; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; cursor: pointer; z-index: 60; transition: all 0.2s; }
        .btn-close-modern:active { transform: scale(0.9); background: #e2e8f0; color: #ef4444; }
        .btn-icon { width: 34px; height: 34px; display: flex; align-items: center; justify-content: center; border-radius: 8px; background: rgba(255,255,255,0.15); color: white; transition: all 0.2s; border: 1px solid rgba(255,255,255,0.1); }
        .btn-icon:active { background: rgba(255,255,255,0.3); transform: scale(0.95); }

        .animate-pop { animation: pop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes pop { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.65); backdrop-filter: blur(4px); z-index: 100; display: flex; align-items: center; justify-content: center; }
        .modal-card { background: white; width: 90%; max-width: 380px; border-radius: 24px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.4); display: flex; flex-direction: column; max-height: 85vh; position: relative; }

        input, select { font-size: 16px !important; border: 1px solid #cbd5e1; border-radius: 10px; padding: 10px; width: 100%; outline: none; color: #0f172a; font-family: 'Sarabun'; transition: border 0.2s; }
        input:focus, select:focus { border-color: var(--primary); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxI_OlN2UjTpTKIqbImcK56672CcLYxeinjQPQkfq3evIYf8ynxXOSWFwp6cLOSBMtC/exec"; 
        const ADMIN_USERNAME = "jiraphong2227";

        const Icons = {
            Book: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>,
            History: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            Camera: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>,
            User: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            Login: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>,
            X: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            ChevronLeft: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="15 18 9 12 15 6"/></svg>,
            ChevronRight: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="9 18 15 12 9 6"/></svg>,
            Check: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><polyline points="20 6 9 17 4 12"/></svg>,
            Alert: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
            Eye: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>,
            EyeOff: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
        };

        const Toast = ({ msg, type }) => (
            <div className={`fixed top-20 left-1/2 -translate-x-1/2 z-[200] px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 animate-pop font-bold text-sm whitespace-nowrap
                ${type === 'success' ? 'bg-white text-green-700 border-l-4 border-green-500' : 'bg-white text-red-700 border-l-4 border-red-500'}`}>
                {type === 'success' ? <Icons.Check /> : <Icons.Alert />}
                {msg}
            </div>
        );

        const CustomDialog = ({ title, message, onConfirm, onCancel }) => (
            <div className="backdrop">
                <div className="bg-white w-[85%] max-w-sm rounded-2xl shadow-2xl p-6 text-center animate-pop">
                    <h3 className="text-lg font-bold text-slate-900 mb-2">{title}</h3>
                    <p className="text-slate-500 text-sm mb-6">{message}</p>
                    <div className="flex gap-3">
                        <button onClick={onCancel} className="flex-1 py-2.5 rounded-xl border border-slate-200 text-slate-600 font-bold hover:bg-slate-50 transition">ยกเลิก</button>
                        <button onClick={onConfirm} className="flex-1 py-2.5 rounded-xl bg-red-600 text-white font-bold hover:bg-red-700 shadow-lg transition">ตกลง</button>
                    </div>
                </div>
            </div>
        );

        const App = () => {
            const [db, setDb] = useState({ bookings: [], users: [], history: [], inspectors: [] });
            const [user, setUser] = useState(JSON.parse(localStorage.getItem('sais_user')) || null);
            const [loading, setLoading] = useState(false);
            
            const [modal, setModal] = useState(null); 
            const [showLogin, setShowLogin] = useState(false);
            const [showManual, setShowManual] = useState(false);
            const [showHistory, setShowHistory] = useState(false);
            const [confirmDialog, setConfirmDialog] = useState(null);
            const [toast, setToast] = useState(null);
            
            const [currentDate, setCurrentDate] = useState(new Date());
            const [period, setPeriod] = useState(0); 

            const isAdmin = useMemo(() => user?.username === ADMIN_USERNAME || user?.role === 'admin', [user]);

            useEffect(() => {
                fetchData();
                const timer = setInterval(() => {
                    if (!modal && !showLogin && !showManual && !showHistory && !confirmDialog) fetchData();
                }, 60000);
                return () => clearInterval(timer);
            }, [modal, showLogin, showManual, showHistory, confirmDialog]);

            const fetchData = async () => {
                if (!SCRIPT_URL) return;
                try {
                    const res = await fetch(SCRIPT_URL);
                    const data = await res.json();
                    setDb(data);
                } catch (e) { console.error(e); }
            };

            const apiAction = async (payload) => {
                setLoading(true);
                try {
                    const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
                    const result = await res.json();
                    setLoading(false);
                    if (result.status === 'ok') {
                        await fetchData();
                        return true;
                    } else {
                        alert('เกิดข้อผิดพลาด: ' + result.message);
                        return false;
                    }
                } catch (e) { 
                    console.error(e);
                    setLoading(false); 
                    alert('การเชื่อมต่อขัดข้อง');
                    return false;
                }
            };

            const showToast = (msg, type = 'success') => {
                setToast({ msg, type });
                setTimeout(() => setToast(null), 3000);
            };

            const changePeriod = (dir) => {
                let newPeriod = period;
                let newDate = new Date(currentDate);
                if (dir === 'next') {
                    if (period === 0) newPeriod = 1; else { newPeriod = 0; newDate.setMonth(newDate.getMonth() + 1); }
                } else {
                    if (period === 1) newPeriod = 0; else { newPeriod = 1; newDate.setMonth(newDate.getMonth() - 1); }
                }
                setPeriod(newPeriod);
                setCurrentDate(newDate);
            };

            const daysInView = useMemo(() => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const lastDay = new Date(year, month + 1, 0).getDate();
                const start = period === 0 ? 1 : 16;
                const end = period === 0 ? 15 : lastDay;
                const days = [];
                for (let i = 0; i < 16; i++) {
                    const d = start + i;
                    if (d <= end) {
                        const date = new Date(year, month, d);
                        const today = new Date();
                        const isDbHoliday = db.bookings.some(b => {
                            const bDate = b.date && b.date.split('T')[0];
                            return bDate === date.toISOString().split('T')[0] && b.inspector_name === 'SYSTEM_HOLIDAY';
                        });
                        days.push({
                            full: date.toISOString().split('T')[0],
                            day: d,
                            weekday: date.toLocaleDateString('en-US', { weekday: 'short' }),
                            isSunday: date.getDay() === 0,
                            isHoliday: isDbHoliday,
                            isToday: date.getDate() === today.getDate() && date.getMonth() === today.getMonth(),
                            isEmpty: false
                        });
                    } else { days.push({ isEmpty: true }); }
                }
                return days;
            }, [currentDate, period, db.bookings]);

            const exportSchedule = async () => {
                setLoading(true);
                const originalGrid = document.querySelector('.grid-container');
                // Temporarily allow overflow for screenshot
                originalGrid.style.overflow = 'visible';
                originalGrid.style.height = 'auto';
                
                await new Promise(r => setTimeout(r, 500));
                
                const element = document.getElementById('schedule-capture-area');
                try {
                    const canvas = await html2canvas(element, { scale: 3, useCORS: true, backgroundColor: '#ffffff', scrollY: 0 });
                    const link = document.createElement('a');
                    link.download = `SAIS_Schedule_${new Date().toISOString().slice(0,10)}.jpg`;
                    link.href = canvas.toDataURL('image/jpeg', 0.95);
                    link.click();
                } catch (e) { showToast('บันทึกรูปไม่สำเร็จ', 'error'); }
                
                // Reset styles
                originalGrid.style.overflow = 'hidden';
                originalGrid.style.height = '';
                setLoading(false);
            };

            const handleLogout = () => {
                setConfirmDialog({
                    title: 'ออกจากระบบ',
                    message: 'คุณต้องการออกจากระบบใช่หรือไม่?',
                    onConfirm: () => {
                        localStorage.removeItem('sais_user');
                        setUser(null);
                        setConfirmDialog(null);
                    }
                });
            };

            return (
                <div className="app-container">
                    {toast && <Toast msg={toast.msg} type={toast.type} />}
                    {loading && <div className="fixed inset-0 z-[150] bg-white/80 flex flex-col items-center justify-center font-bold text-red-600"><div className="w-10 h-10 border-4 border-red-200 border-t-red-600 rounded-full animate-spin mb-3"></div>กำลังบันทึก...</div>}
                    
                    {confirmDialog && (
                        <CustomDialog 
                            title={confirmDialog.title} 
                            message={confirmDialog.message} 
                            onConfirm={confirmDialog.onConfirm} 
                            onCancel={() => setConfirmDialog(null)} 
                        />
                    )}

                    {/* Header */}
                    <header className="main-header">
                        <div className="flex items-center gap-2">
                            <h1 className="text-xl font-bold tracking-wide">SAIS BOOKING</h1>
                        </div>
                        <div className="flex items-center gap-2">
                            <button className="btn-icon" onClick={() => setShowManual(true)} title="คู่มือ"><Icons.Book /></button>
                            <button className="btn-icon" onClick={() => setShowHistory(true)} title="ประวัติ"><Icons.History /></button>
                            <button className="btn-icon" onClick={exportSchedule} title="บันทึกรูป"><Icons.Camera /></button>
                            {user ? (
                                <button className="ml-1 bg-white text-red-700 px-3 py-1.5 rounded-lg font-bold text-xs shadow flex items-center gap-2" 
                                    onClick={handleLogout}>
                                    {user.full_name.split(' ')[0]} <Icons.Login />
                                </button>
                            ) : (
                                <button className="ml-1 bg-white text-red-700 px-4 py-1.5 rounded-lg font-bold text-xs shadow flex items-center gap-2" onClick={() => setShowLogin(true)}>
                                    LOGIN <Icons.User />
                                </button>
                            )}
                        </div>
                    </header>

                    {/* Grid */}
                    <div className="grid-container" id="schedule-capture-area">
                        <div className="nav-bar">
                            <button onClick={() => changePeriod('prev')} className="px-3 py-1.5 bg-slate-100 rounded-lg text-xs font-bold text-slate-600 flex items-center gap-1 active:bg-slate-200"><Icons.ChevronLeft /> ย้อนกลับ</button>
                            <div className="text-center">
                                <div className="text-lg font-bold text-slate-800">{currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</div>
                            </div>
                            <button onClick={() => changePeriod('next')} className="px-3 py-1.5 bg-slate-100 rounded-lg text-xs font-bold text-slate-600 flex items-center gap-1 active:bg-slate-200">ถัดไป <Icons.ChevronRight /></button>
                        </div>

                        <div className="table-header">
                            <div className="w-[50px] flex items-center justify-center py-2 bg-slate-900 border-r border-slate-600"><span className="text-[10px] font-bold text-slate-400">DATE</span></div>
                            {db.inspectors.map((ins, i) => (
                                <div key={i} className="flex-1 flex flex-col items-center justify-center py-2 border-r border-slate-600 min-w-0">
                                    <div className="font-bold truncate w-full text-center px-1 text-[11px] text-white">{ins.name}</div>
                                    <div className="text-[9px] text-slate-400 font-bold uppercase">{ins.short}</div>
                                </div>
                            ))}
                        </div>

                        <div className="grid-body">
                            {daysInView.map((d, index) => (
                                <div key={index} className={`grid-row ${d.isEmpty ? 'bg-slate-50' : ''} ${d.isHoliday ? 'is-holiday-row' : ''}`}>
                                    {/* Date Cell */}
                                    <div className={`cell-date ${d.isSunday ? 'is-sunday' : ''} ${d.isToday ? 'is-today' : ''}`}
                                        onClick={() => {
                                            if(isAdmin && !d.isEmpty) {
                                                setConfirmDialog({
                                                    title: 'ตั้งค่าวันหยุด',
                                                    message: `ต้องการตั้งค่า ${d.full} เป็นวันหยุดหรือไม่?`,
                                                    onConfirm: () => {
                                                        apiAction({ action: 'create_booking', inspector_name: 'SYSTEM_HOLIDAY', date: d.full, site_name: 'HOLIDAY', user: user.username });
                                                        setConfirmDialog(null);
                                                    }
                                                });
                                            }
                                        }}
                                    >
                                        {!d.isEmpty && (
                                            <>
                                                <span className="leading-none font-bold">{d.day}</span>
                                                <span className={`text-[9px] mt-0.5 font-bold uppercase ${d.isSunday ? 'text-white' : 'text-slate-400'}`}>{d.weekday}</span>
                                            </>
                                        )}
                                    </div>
                                    {!d.isEmpty && db.inspectors.map((ins, idx) => {
                                        const isOffDay = d.isHoliday || d.isSunday;
                                        const task = db.bookings.find(b => {
                                            const bDate = b.date && b.date.split('T')[0];
                                            return bDate === d.full && b.inspector_name === ins.name;
                                        });
                                        const hasTask = !!task;
                                        
                                        return (
                                            <div key={idx} className={`cell-slot ${isOffDay && !hasTask ? (d.isSunday ? 'is-sunday-slot' : 'bg-red-50/40') : ''}`}
                                                onClick={() => {
                                                    if (hasTask) setModal({ type: 'detail', data: task });
                                                    else {
                                                        if (isOffDay && !isAdmin) return;
                                                        if (!user) { setShowLogin(true); return; }
                                                        setModal({ type: 'booking', data: { date: d.full, inspector_name: ins.name } });
                                                    }
                                                }}
                                            >
                                                {isOffDay && !hasTask && <span className={d.isSunday ? "sunday-holiday-text" : "holiday-label"}>{d.isSunday ? "SUNDAY" : "OFF"}</span>}
                                                {hasTask && (
                                                    <div className={`task-content ${task.status === 'pending' ? 'status-pending' : 'status-done'}`}>
                                                        <div className="text-line-1">
                                                            {task.equipment_no} <span className="text-slate-400 font-normal">/</span> {task.unit_no}
                                                        </div>
                                                        <div className="text-line-2">
                                                            {task.site_name}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* --- Login Popup --- */}
                    {showLogin && (
                        <LoginComponent 
                            onClose={() => setShowLogin(false)} 
                            users={db.users} 
                            onLogin={(u) => { setUser(u); localStorage.setItem('sais_user', JSON.stringify(u)); setShowLogin(false); showToast('ยินดีต้อนรับ', 'success'); }}
                            apiAction={apiAction}
                            showToast={showToast}
                        />
                    )}

                    {/* --- Manual Popup --- */}
                    {showManual && (
                        <div className="backdrop">
                            <div className="modal-card h-[60vh]">
                                <div className="p-4 border-b flex justify-between items-center bg-slate-50">
                                    <h2 className="font-bold text-lg text-slate-800 flex items-center gap-2"><Icons.Book /> คู่มือการใช้งาน</h2>
                                    <button onClick={() => setShowManual(false)} className="btn-close-modern relative top-0 right-0"><Icons.X /></button>
                                </div>
                                <div className="p-6 overflow-y-auto text-sm text-slate-600 space-y-4 font-light leading-relaxed">
                                    <p>• สามารถดูตารางงานได้โดยไม่ต้อง Login</p>
                                    <p>• ต้อง <b>Login</b> เพื่อทำการจองหรือแก้ไข</p>
                                    <p>• ช่องสีแดงคือวันหยุด <span className="text-red-500 font-bold">(OFF)</span></p>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* --- History Popup --- */}
                    {showHistory && (
                        <div className="backdrop">
                            <div className="modal-card h-[70vh]">
                                <div className="p-4 border-b flex justify-between items-center bg-slate-50">
                                    <h2 className="font-bold text-lg text-slate-800 flex items-center gap-2"><Icons.History /> ประวัติ</h2>
                                    <button onClick={() => setShowHistory(false)} className="btn-close-modern relative top-0 right-0"><Icons.X /></button>
                                </div>
                                <div className="flex-1 overflow-auto p-4 space-y-2">
                                    {[...db.history].reverse().slice(0, 50).map(h => (
                                        <div key={h.id} className="p-3 bg-slate-50 border rounded-xl text-xs">
                                            <div className="flex justify-between text-slate-500 mb-1">
                                                <span>{new Date(h.timestamp).toLocaleString('th-TH')}</span>
                                                <b className="text-slate-700">{h.user}</b>
                                            </div>
                                            <div className="text-slate-800 font-medium">{h.details}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* --- Booking/Detail Modal --- */}
                    {modal && (
                        <div className="backdrop">
                            <div className="modal-card">
                                <button onClick={() => setModal(null)} className="btn-close-modern"><Icons.X /></button>
                                <div className="p-6 overflow-y-auto">
                                    <div className="mb-6 border-b pb-4 pr-10">
                                        <h3 className="text-xl font-bold text-slate-900">{modal.type === 'booking' ? 'จองคิวตรวจ' : 'รายละเอียด'}</h3>
                                        <div className="text-xs text-red-600 font-bold uppercase mt-1 flex items-center gap-1">
                                            {modal.data.inspector_name} • {modal.data.date}
                                        </div>
                                    </div>

                                    {modal.type === 'booking' ? (
                                        <form onSubmit={async (e) => {
                                            e.preventDefault();
                                            const fd = new FormData(e.target);
                                            // ** Send default time_slot to allow backend processing **
                                            const payload = { 
                                                action: modal.data.id ? 'update_booking' : 'create_booking', 
                                                ...Object.fromEntries(fd), 
                                                time_slot: '-', // Default hidden value
                                                id: modal.data.id, 
                                                inspector_name: modal.data.inspector_name, 
                                                date: modal.data.date, 
                                                user: user.username 
                                            };
                                            
                                            setLoading(true);
                                            const ok = await apiAction(payload);
                                            setLoading(false);
                                            if(ok) { setModal(null); showToast('บันทึกสำเร็จ!', 'success'); }
                                        }} className="space-y-3">
                                            <div><label className="text-xs font-bold text-slate-500">Project</label><input name="site_name" defaultValue={modal.data.site_name} required className="p-3 bg-slate-50 font-bold" placeholder="ชื่อโครงการ" /></div>
                                            <div className="grid grid-cols-2 gap-2">
                                                <div><label className="text-xs font-bold text-slate-500">Eq No.</label><input name="equipment_no" defaultValue={modal.data.equipment_no} required className="p-3 bg-slate-50" placeholder="XXXX" /></div>
                                                <div><label className="text-xs font-bold text-slate-500">Unit</label><input name="unit_no" defaultValue={modal.data.unit_no} required className="p-3 bg-slate-50" placeholder="A1" /></div>
                                            </div>
                                            
                                            <div><label className="text-xs font-bold text-slate-500">Area</label><select name="area" defaultValue={modal.data.area} className="p-3 bg-slate-50"><option>BKK</option><option>CM</option><option>PK</option><option>Others</option></select></div>
                                            
                                            <div className="grid grid-cols-2 gap-2">
                                                <div><label className="text-xs font-bold text-slate-500">Foreman</label><input name="foreman" defaultValue={modal.data.foreman} className="p-3 bg-slate-50" placeholder="ชื่อ" /></div>
                                                <div><label className="text-xs font-bold text-slate-500">Tel</label><input name="tel" defaultValue={modal.data.tel} type="tel" className="p-3 bg-slate-50" placeholder="08x-xxx-xxxx" /></div>
                                            </div>
                                            <button className="w-full py-3 mt-4 rounded-xl bg-red-600 text-white font-bold text-sm shadow-md active:bg-red-700 transition">
                                                {modal.data.id ? 'อัปเดตข้อมูล' : 'ยืนยันการจอง'}
                                            </button>
                                        </form>
                                    ) : (
                                        <div className="space-y-5">
                                            <h2 className="text-xl font-bold text-slate-900">{modal.data.site_name}</h2>
                                            <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 grid grid-cols-2 gap-y-4 text-sm">
                                                <div><span className="text-xs text-slate-400 block font-bold">Eq No.</span><b>{modal.data.equipment_no}</b></div>
                                                <div><span className="text-xs text-slate-400 block font-bold">Unit</span><b>{modal.data.unit_no}</b></div>
                                                <div><span className="text-xs text-slate-400 block font-bold">Foreman</span><b>{modal.data.foreman}</b></div>
                                                <div><span className="text-xs text-slate-400 block font-bold">Tel</span><a href={`tel:${modal.data.tel}`} className="text-blue-600 font-bold">{modal.data.tel}</a></div>
                                                {/* Hidden Time Slot display */}
                                            </div>
                                            
                                            <div className="space-y-2 pt-2">
                                                <div className="text-xs font-bold text-slate-500 uppercase">Documents</div>
                                                {['layout_doc', 'wiring_doc', 'precheck_doc'].map(doc => (
                                                    <div key={doc} className="flex justify-between items-center p-3 border rounded-xl bg-white shadow-sm">
                                                        <span className="text-xs font-bold text-slate-600">{doc.replace('_doc','').toUpperCase()}</span>
                                                        {isAdmin ? (
                                                            <input type="checkbox" className="w-5 h-5 accent-green-600" checked={modal.data[doc] === 'true'}
                                                                onChange={async(e) => {
                                                                    const val = e.target.checked ? 'true' : 'false';
                                                                    setModal(p => ({...p, data: {...p.data, [doc]: val}}));
                                                                    await apiAction({ action: 'update_doc_status', id: modal.data.id, doc_type: doc, status: val });
                                                                }}
                                                            />
                                                        ) : (
                                                            <span className={`text-[10px] px-2 py-1 rounded font-bold ${modal.data[doc] === 'true' ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-400'}`}>
                                                                {modal.data[doc] === 'true' ? 'PASS' : 'WAIT'}
                                                            </span>
                                                        )}
                                                    </div>
                                                ))}
                                            </div>

                                            {(isAdmin || user?.username === modal.data.created_by) && (
                                                <div className="flex gap-2 mt-4">
                                                    <button onClick={() => setModal({ type: 'booking', data: modal.data })} className="flex-1 py-3 rounded-xl border border-slate-300 text-slate-700 font-bold text-sm hover:bg-slate-50">แก้ไข</button>
                                                    <button onClick={() => {
                                                        setConfirmDialog({
                                                            title: 'ลบรายการ',
                                                            message: 'ยืนยันการลบรายการนี้?',
                                                            onConfirm: async () => {
                                                                const ok = await apiAction({ action: 'delete_booking', id: modal.data.id, user: user.username, target_name: modal.data.site_name });
                                                                if(ok) { setModal(null); setConfirmDialog(null); showToast('ลบรายการสำเร็จ', 'success'); }
                                                            }
                                                        });
                                                    }} className="flex-1 py-3 rounded-xl border border-red-200 text-red-600 font-bold text-sm hover:bg-red-50">ลบ</button>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* --- Login Popup --- */}
                    {showLogin && (
                        <LoginComponent 
                            onClose={() => setShowLogin(false)} 
                            users={db.users} 
                            onLogin={(u) => { setUser(u); localStorage.setItem('sais_user', JSON.stringify(u)); setShowLogin(false); showToast('ยินดีต้อนรับ', 'success'); }}
                            apiAction={apiAction}
                            showToast={showToast}
                        />
                    )}
                </div>
            );
        };

        // --- Login Component ---
        const LoginComponent = ({ onClose, users, onLogin, apiAction, showToast }) => {
            const [mode, setMode] = useState('login');
            const [showPwd, setShowPwd] = useState(false);
            const [isSubmitting, setIsSubmitting] = useState(false);

            return (
                <div className="backdrop">
                    <div className="modal-card p-6">
                        <button onClick={onClose} className="btn-close-modern"><Icons.X /></button>
                        <div className="text-center mb-6 mt-2">
                            <h2 className="text-2xl font-bold text-slate-800">{mode === 'signup' ? 'สมัครสมาชิก' : 'เข้าสู่ระบบ'}</h2>
                            <p className="text-slate-500 text-xs mt-1">เพื่อจอง/แก้ไข/ลบ คิวตรวจ SAIS</p>
                        </div>
                        
                        {mode === 'login' ? (
                            <form onSubmit={(e) => {
                                e.preventDefault();
                                const fd = new FormData(e.target);
                                const u = users.find(x => x.username === fd.get('username').trim() && String(x.password) === fd.get('password').trim());
                                if (u) {
                                    if (u.role === 'pending') alert('รออนุมัติสิทธิ์จาก Admin');
                                    else onLogin(u);
                                } else alert('ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง');
                            }} className="space-y-4">
                                <input name="username" placeholder="Username" className="bg-slate-50" />
                                <div className="relative">
                                    <input name="password" type={showPwd ? "text" : "password"} placeholder="Password" className="bg-slate-50 pr-10" />
                                    <button type="button" onClick={() => setShowPwd(!showPwd)} className="absolute right-3 top-3 text-slate-400">
                                        {showPwd ? <Icons.EyeOff /> : <Icons.Eye />}
                                    </button>
                                </div>
                                <button className="w-full py-3.5 rounded-xl bg-red-600 text-white font-bold shadow-lg text-lg">LOGIN</button>
                                <button type="button" onClick={() => setMode('signup')} className="w-full text-center text-slate-500 text-sm mt-4 underline">สมัครสมาชิก</button>
                            </form>
                        ) : (
                            <form onSubmit={async (e) => {
                                e.preventDefault();
                                setIsSubmitting(true);
                                const fd = new FormData(e.target);
                                if (!fd.get('email').endsWith('@schindler.com')) { alert('ต้องใช้ Email @schindler.com'); setIsSubmitting(false); return; }
                                const ok = await apiAction({ action: 'signup', ...Object.fromEntries(fd) });
                                setIsSubmitting(false);
                                if (ok) { alert('ลงทะเบียนสำเร็จ! รออนุมัติ'); setMode('login'); }
                            }} className="space-y-3">
                                <input name="full_name" required placeholder="ชื่อ-นามสกุล" className="bg-slate-50" />
                                <input name="email" required placeholder="Email (@schindler.com)" className="bg-slate-50" />
                                <input name="username" required placeholder="Username" className="bg-slate-50" />
                                <input name="password" required placeholder="Password" className="bg-slate-50" />
                                <input name="phone" required placeholder="เบอร์โทร" className="bg-slate-50" />
                                <button disabled={isSubmitting} className="w-full py-3.5 rounded-xl bg-red-600 text-white font-bold shadow-lg text-lg mt-2">
                                    {isSubmitting ? 'กำลังบันทึก...' : 'ยืนยันการสมัคร'}
                                </button>
                                <button type="button" onClick={() => setMode('login')} className="w-full text-center text-slate-500 text-sm mt-2">กลับไปหน้าเข้าสู่ระบบ</button>
                            </form>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
